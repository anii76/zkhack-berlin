<!DOCTYPE html>
<html>
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="preconnect" href="https://fonts.gstatic.com/" crossorigin />
    <link rel="stylesheet" as="style" onload="this.rel='stylesheet'" href="https://fonts.googleapis.com/css2?display=swap&family=Inter:wght@400;500;700;900&family=Noto+Sans:wght@400;500;700;900" />
    <title>Face Scan - ZK FacePay</title>
    <link rel="icon" type="image/x-icon" href="data:image/x-icon;base64," />
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
  </head>
  <body>
    <div class="min-h-screen bg-gradient-to-br from-slate-900 via-purple-900 to-slate-900 flex items-center justify-center p-4" style='font-family: Inter, "Noto Sans", sans-serif;'>
      <div class="w-full max-w-md">
        <button onclick="window.location.href='/'" class="flex items-center text-white mb-4 gap-2 hover:text-purple-300 transition-colors" style="background: none; border: none;">
          <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" /></svg>
          Back
        </button>
        <div class="bg-white/10 backdrop-blur-lg border border-white/20 rounded-2xl shadow-lg p-8">
          <h2 class="text-white text-2xl font-bold text-center mb-2">Face Scan</h2>
          <h3 class="text-white text-xl font-semibold text-center mb-3">Position your face in the frame</h3>
          <p class="text-slate-300 text-base text-center mb-6">Ensure your face is fully visible and well-lit for accurate scanning.</p>
          <div class="flex w-full grow justify-center mb-4">
            <div class="w-full max-w-xs aspect-[2/3] rounded-lg flex items-center justify-center video-container relative" style="height: 320px; max-width: 100vw;">
              <video id="inputVideo" autoplay muted playsinline class="rounded-lg bg-black w-full h-full object-cover"></video>
              <canvas id="overlay" class="rounded-lg w-full h-full absolute top-0 left-0"></canvas>
            </div>
          </div>
          <div class="flex w-full">
            <button id="scanFaceBtn" class="w-full rounded-lg h-12 bg-gradient-to-r from-blue-500 to-purple-500 hover:from-blue-600 hover:to-purple-600 text-white text-base font-bold transition-colors">
              Scan Face
            </button>
          </div>
          <div id="scan-success" class="hidden flex flex-col items-center justify-center py-6">
            <div class="text-green-400 text-xl font-bold mb-2">ðŸŽ‰ Success!</div>
            <div class="text-white text-base font-normal mb-2">You have claimed your funds.</div>
          </div>
          <div id="scan-loading" class="hidden flex flex-col items-center justify-center py-6">
            <div class="text-blue-400 text-xl font-bold mb-2">Scanning...</div>
          </div>
        </div>
      </div>
    </div>
    <script src="/face-api.js"></script>
    <script>
      let stream;
      let isModelLoaded = false;
      async function startWebcam() {
        stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: { exact: 'environment' } } }).catch(async () => {
          return await navigator.mediaDevices.getUserMedia({ video: true });
        });
        const videoEl = document.getElementById('inputVideo');
        videoEl.srcObject = stream;
      }
      async function loadModels() {
        await faceapi.nets.tinyFaceDetector.load('/models/');
        isModelLoaded = true;
      }
      async function detectFace() {
        const videoEl = document.getElementById('inputVideo');
        const canvas = document.getElementById('overlay');
        const displaySize = { width: videoEl.videoWidth, height: videoEl.videoHeight };
        faceapi.matchDimensions(canvas, displaySize);
        const detection = await faceapi.detectSingleFace(videoEl, new faceapi.TinyFaceDetectorOptions());
        const resizedDetections = detection ? faceapi.resizeResults(detection, displaySize) : null;
        canvas.getContext('2d').clearRect(0, 0, canvas.width, canvas.height);
        if (resizedDetections) {
          faceapi.draw.drawDetections(canvas, resizedDetections);
        }
        return detection;
      }
      document.addEventListener('DOMContentLoaded', async function() {
        await loadModels();
        await startWebcam();
        document.getElementById('scanFaceBtn').onclick = async function() {
          document.getElementById('scan-loading').classList.remove('hidden');
          this.disabled = true;
          this.innerHTML = '<span class="truncate">Scanning...</span>';
          const detection = await detectFace();
          setTimeout(() => {
            document.getElementById('scan-loading').classList.add('hidden');
            if (detection) {
              if (stream) stream.getTracks().forEach(t => t.stop());
              // Mock values for amount/address
              const amount = '0.5ETH';
              const address = '0x123...abc';
              window.location.href = `/success?amount=${encodeURIComponent(amount)}&address=${encodeURIComponent(address)}`;
            } else {
              this.disabled = false;
              this.innerHTML = '<span class="truncate">Scan Face</span>';
              alert('No face detected. Try again.');
            }
          }, 1200);
        };
      });
    </script>
  </body>
</html> 